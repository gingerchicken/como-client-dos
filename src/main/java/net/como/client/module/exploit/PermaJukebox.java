package net.como.client.module.exploit;

import net.como.client.ComoClient;
import net.como.client.event.EventHandler;
import net.como.client.event.impl.InteractBlockEvent;
import net.como.client.event.impl.SendPacketEvent;
import net.como.client.module.Module;
import net.minecraft.client.network.ClientPlayerEntity;
import net.minecraft.item.ItemStack;
import net.minecraft.item.MusicDiscItem;
import net.minecraft.network.packet.c2s.play.PlayerActionC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayerInteractBlockC2SPacket;
import net.minecraft.util.Hand;
import net.minecraft.util.hit.BlockHitResult;

public class PermaJukebox extends Module {

    private boolean ignoreNext = false;

    public PermaJukebox() {
        this.setDescription("Allows you to play music in the jukebox forever");
        this.setCategory("Exploit");
    }

    @Override
    protected void onEnable() {
        super.onEnable();
        ignoreNext = false;
    }

    @EventHandler
    public void onPacket(SendPacketEvent event) {
        if (ignoreNext) { // Prevent infinite loop
            ignoreNext = false;
            return;
        }

        // Get the local player
        ClientPlayerEntity player = ComoClient.getInstance().me();

        // Check if we're in creative mode
        if (!player.isCreative()) return;

        // Check if the packet is an interact block packet
        if (!(event.packet instanceof PlayerInteractBlockC2SPacket)) return;

        // Get the packet
        PlayerInteractBlockC2SPacket packet = (PlayerInteractBlockC2SPacket) event.packet;

        Hand hand = packet.getHand();
        BlockHitResult hitResult = packet.getBlockHitResult();

        // Check that the block is a jukebox
        if (!player.getWorld().getBlockState(hitResult.getBlockPos()).isOf(net.minecraft.block.Blocks.JUKEBOX)) return;

        // Check if we are holding a music disc
        ItemStack usedItem = player.getStackInHand(hand);
        if (!(usedItem.getItem() instanceof MusicDiscItem)) return;

        // Send the packet to the server
        ignoreNext = true;
        ComoClient.getInstance().getClient().getNetworkHandler().sendPacket(packet);

        // Break the jukebox
        PlayerActionC2SPacket breakPacket = new PlayerActionC2SPacket(PlayerActionC2SPacket.Action.START_DESTROY_BLOCK, hitResult.getBlockPos(), hitResult.getSide(), 0);
        ComoClient.getInstance().getClient().getNetworkHandler().sendPacket(breakPacket);
    }
}
